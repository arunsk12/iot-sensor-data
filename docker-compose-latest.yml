version: '3.8'

services:
  zookeeper-1:
    image: confluentinc/cp-zookeeper:7.4.4
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - 22181:2181

  kafka-1:
    image: confluentinc/cp-kafka:7.4.4
    depends_on:
      - zookeeper-1
    ports:
      - 29092:29092 # Port for host access to Kafka
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper-1:2181
      # CORRECTED KAFKA ADVERTISED LISTENERS FOR INTERNAL (kafka-1:9092) AND EXTERNAL (localhost:29092) ACCESS
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-1:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1

  clickhouse-server:
    image: clickhouse/clickhouse-server:latest
    hostname: clickhouse-server
    container_name: clickhouse-server
    ports:
      - "8123:8123" # HTTP interface
      - "9000:9000" # Native interface
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - clickhouse_logs:/var/log/clickhouse-server
      - ./clickhouse/config.xml:/etc/clickhouse-server/config.xml
      - ./clickhouse/users.xml:/etc/clickhouse-server/config.d/users.xml
      - ./clickhouse/init.sql:/docker-entrypoint-initdb.d/init.sql # SQL to run on startup      
    environment:
      CLICKHOUSE_USER: iot_user
      CLICKHOUSE_PASSWORD: iot_password
      CLICKHOUSE_DB: iot_analytics
    healthcheck:
      test: ["CMD", "bash", "-c", "clickhouse client -q 'SELECT 1'"]
      interval: 5s
      timeout: 2s
      retries: 5
    networks:
      - default

  jobmanager:
    image: apache/flink:latest # Use Flink 1.17.1 (matches JAR build)
    hostname: jobmanager
    container_name: jobmanager
    ports:
      - "8081:8081" # Flink Web UI
    command: jobmanager
    environment:
      FLINK_PROPERTIES_jobmanager_rpc_address: jobmanager
    depends_on:
      - kafka-1
      - clickhouse-server
    networks:
      - default

  taskmanager:
    image: apache/flink:latest # Use Flink 1.17.1 (matches JAR build)
    hostname: taskmanager
    container_name: taskmanager
    command: taskmanager
    environment:
      FLINK_PROPERTIES_jobmanager_rpc_address: jobmanager
      FLINK_PROPERTIES_taskmanager_numberOfTaskSlots: 2 # Adjust based on your available CPU/memory
    depends_on:
      - jobmanager
    networks:
      - default

  superset:
    image: apache/superset:latest # Pinning to 3.1.0 for stability
    hostname: superset
    container_name: superset
    ports:
      - "8088:8088" # Superset Web UI
    environment:
      SUPERSET_LOAD_EXAMPLES: "no"
      SUPERSET_WEBSERVER_PORT: 8088
      FLASK_APP: superset
      SECRET_KEY: "THIS_IS_A_DEV_SECRET_KEY" # **CHANGE THIS FOR PRODUCTION**
    volumes:
      - superset_home:/app/superset_home
      - ./superset_config.py:/app/superset_config.py
    depends_on:
      - clickhouse-server
    command: ["/bin/sh", "-c", "sleep 10 && superset db upgrade && superset fab create-admin --username admin --firstname Superset --lastname Admin --email admin@superset.com --password admin || true && superset init && superset run -h 0.0.0.0 -p 8088 --with-threads --reload --debugger"]
    networks:
      - default

  data-simulator:
    build:
      context: ./data-simulator # Build from the data-simulator directory
      dockerfile: Dockerfile    # Use the Dockerfile in that directory
    container_name: data-simulator
    depends_on:
      - kafka-1 # Simulator sends data to Kafka
    networks:
      - default
    volumes:
      - ./data-simulator:/app
    command: python /app/simulator.py

volumes:
  clickhouse_data:
  clickhouse_logs:
  superset_home:

networks:
  default:
    driver: bridge